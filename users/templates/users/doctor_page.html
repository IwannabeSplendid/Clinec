{% extends 'users/layout.html' %}
{% block head %}

    <title>{{request.user.username}}</title>

    <style>
        


        .assigned_patients{
            padding-left: 5%;
            display: flex;
            gap:20px;
        }

        .assigned_patients > *{
            flex-flow: column;
        }

        #treatment-popup{
            position: fixed;
            top: 20%;
            left: 50%;
            background-color: darkcyan;
            border-radius: 10px;
            visibility: hidden;
        }
        
        .treatment-history{
            visibility: hidden;
            position:fixed;
            top:20%;
            left:20%;
            width:40%;
            background-color: darkorchid;
            border-radius: 12px;
        }

        #chat-button{
            position: fixed;
            bottom: 5%;
            right: 5%;            

        }

        #chats{
            position: fixed;
            bottom: 8%;
            right: 5%;
            border: 1px solid black;
            border-radius: 5%;
            background-color: white;

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;

            visibility: hidden;
        }

        .chatroom-div{
            border: 1px solid black;
            position: fixed;
            bottom: 8%;
            right: 5%;

            visibility: hidden;
        }
    </style>

    
{% endblock %}


{%block body%}

    <div style="border: 1px solid pink">
        <h3>personal page</h3>

        <p><img src="{{request.user.doctor.photo.url}}" alt="{{request.user.doctor.photo.url}}" width="200px"></p>

        <p>Doctor {{request.user.doctor.name}} {{request.user.doctor.surname}}</p>

        <!-- Patients and their treatments -->
        <!-- iterating through doctor's patients - patient model's objects :: accessing through user, through user the doctor model (extension model), through it the patients-->
        
        <strong>Patients</strong>
        {% for patient in request.user.doctor.assigned_patients.all %}
            
            <div class="assigned_patients">
                <div>{{patient}}</div>
                <div>
                    Treatments
                    {% for treatment in patient.treatments.all|dictsortreversed:"date" %} <!-- iterating through treatments sorted by date, and showing only the first one (last assigned treatment) -->
                    <div style="border: 1px solid red">
                        {% if forloop.counter == 1 %}
                            <p>Description: {{treatment.description}}</p>
                            <p>Medicaments: {{treatment.medicaments}}</p>
                            <p>Date: {{treatment.date}}</p>
                        {%endif%}
                    </div>
                    {%empty%}
                        <p><i>There are no treatments yet</i></p>
                    {% endfor %}
                

                <!-- button to open popup to add treatment to this patient -->
                <div >
                    <p style="display: flex; flex-flow: row; gap: 5px;">
                        <input type="hidden" value="{{patient}}" class="patient-repr">
                        <input type="hidden" value="{{patient.gov_id}}" class="patient-id">
                        <button onclick="show_treatment_popup($(this).parent().children('.patient-repr'), $(this).parent().children('.patient-id'))">Add treatment</button>
                        <button onclick="show_treatment_history($(this).parent().children('.patient-id'))">View treatment history</button>
                    </p>    

                </div>
                </div>
            </div>


            <!-- treatment history -->
            <div class="treatment-history" id="treatment-history-{{patient.gov_id}}">
                Treatments
                {% for treatment in patient.treatments.all|dictsortreversed:"date" %} <!-- sorting by date in reverse -->
                    <div style="border: 1px solid red">
                        <p>Description: {{treatment.description}}</p>
                        <p>Medicaments: {{treatment.medicaments}}</p>
                        <p>Date: {{treatment.date}}</p>
                    </div>
                {%empty%}
                    <i>There are no treatments yet</i>
                {% endfor %}
                
                <p><button onclick="close_treatment_history($(this).parent().parent())">close</button></p>
            </div>

            <!-- treatment popup :: has to be inside loop for patient info -->
            <div id="treatment-popup">
                <form action="{%url 'treatment' %}" method="post">
                    {% csrf_token %}
                    <p>Patient: <input type="text" id="treatment-popup-patient" name="patient"  readonly></p>
                    <input type="text" name="gov_id" id="treatment-popup-patient-id"  hidden> <!-- hidden input to get the id of patient - to create treatment model object-->
                    <p>Description: <textarea name="description" id="" cols="30" rows="10" value="" required></textarea></p>
                    <p>Medicaments: <textarea name="medicaments" id="" cols="15" rows="2" value="" required></textarea></p>
                    <p>Set date: <input type="date" name="date" id="" required></p>
                    <p><input type="submit" value="Save treatment"></p>
                </form>
                <button onclick="close_treatment_popup()">Close</button>
            </div>

        {%empty%}

            <i>There are no assigned patients</i>

        {% endfor %}
    </div>

    <br>


    <!-- Appointments -->
    <div style="border: 1px solid blue">
        <h3>Appointments</h3>
        {% for appointment in user.doctor.appointments.all|dictsort:"date" %}

            <p>{{appointment}}</p>

        {% empty %}

            <p><i>There are no appointments yet scheduled</i></p>

        {% endfor %}
    </div>

    <p></p>
    <p><a href="{% url 'logout' %}">log out</a></p>



    <!-- chatdiv -->
    <div id="chats">
        {% for patient in request.user.doctor.assigned_patients.all %} 
            <p><button class="chat-buttons" onclick="chat_show($(this).parent().children('input').val())">{{patient}}</button>
                <input type="hidden" value="{{patient.chatrooms.first.id}}"></p>
        {% empty %}
            You have not patients yet
        {% endfor %}
    </div>

    <button id="chat-button">Chats with Patients</button>


    <!-- chat popups with each patient -->
    {% for patient in request.user.doctor.assigned_patients.all %}

        <div class="chatroom-div" id="chatroom-{{patient.chatrooms.first.id}}">

            <i>Chat with {{patient}}</i>

            <!-- div of messages -->
            <div class="chat-messages" id="chat-messages-{{patient.chatrooms.first.id}}">
            </div>

            <!-- to show messages, design as a real chat -->
            <form method="post" class="chat-form">
                {%csrf_token%}
                <input type="text" value="" name="message" class="message_text" autocomplete="off">  <!--classes, not id-s, because there are going to be a form per patient, and the values are accessed as the form's children that belong to those classes-->
                <input type="submit" value="send" id="submit_button">

                <!-- hidden inputs to pass chatroom_id via js-ajax -->
                <input type="hidden" value="{{patient.chatrooms.first.id}}" class="chatroom_id">
            </form>

            <!-- button when clicked: close div and clear interval -->
            <button id="close-chat-btn-{{patient.chatrooms.first.id}}">Close chat</button>
        </div>
    {% empty %}
        <p>There are no assigned patients</p>
    {% endfor %}


<!-- JS -->

    <!-- chat JS -->
    <script>
        let chat_opened = false;

        //open and close chat
        $('#chat-button').click(function(){

            if (!chat_opened){
                document.getElementById('chats').style.visibility='visible';
                document.getElementById('chat-button').textContent = 'Close';
                chat_opened = true;
            }
            else{
                document.getElementById('chats').style.visibility='hidden';
                document.getElementById('chat-button').textContent = 'Chats with Patients';
                chat_opened=false;
            }
        })


        //function to show chatroom
        function chat_show(chatroom_id){

            //close chat choosing view
            document.getElementById('chats').style.visibility='hidden';

            //console.log(chatroom_id);

            //show the chatroom
            $('#chatroom-'+chatroom_id).css("visibility", "visible");

            let chat_interval = setInterval(function(){

                    $.ajax({
                        type : 'GET',
                        url : 'updateMessages/'+ chatroom_id,

                        //take response (contains info of messages in chatroom) and show messages
                        success : function(response){
                            //empty the div
                            $('.chat-messages').empty();

                            //console.log(response.user)

                            for (var key in response.messages){
                                temp = "<hr><p><b>"+response.messages[key].username+"</b></p> <p>"+response.messages[key].message_text+"</p> <p>"+response.messages[key].date+"</p>";
                                $('#chat-messages-'+chatroom_id).append(temp);
                            }
                        }
                    });

                }, 1000);

            $('#close-chat-btn-'+chatroom_id).click(function(){
                $(this).parent().css('visibility', 'hidden'); 
                clearInterval(chat_interval);
            });

        }


        //function using jquery syntax to (constantly check inputs from page? async-ly?)
        $(document).on('submit', '.chat-form', function(e){

            //prevent automatic refreshment when submitting - maybe the reason using ajax here
            e.preventDefault()
            
            //console.log('chatroom id is' + $(this).children('.chatroom_id').val())

            $.ajax({
                type: 'POST',

                //getting chatroom_id using the hidden input inside the form, that has a val of chatroom_id set using jinja
                url: 'send/'+$(this).children('.chatroom_id').val(),

                data:{
                    message_text : $(this).children('.message_text').val(),
                    csrfmiddlewaretoken : $(this).children('input[name=csrfmiddlewaretoken]').val(),  //each form's csrf token
                },
                success : function(data){
                    //console.log(data)
                }
            });

            //empty the message field
            $(this).children('.message_text').val("");

        });

        //function to update the div of chat every second (1000 ms)

    </script>

    <!-- JS to show 'make-new-treatment' and 'see-treatment-history' popups -->
    <script>
        function show_treatment_popup(patient, patient_id){
            //console.log(patient.val(), patient_id.val())
            
            //set popups vals to patient's
            $('#treatment-popup-patient').val(patient.val());
            $('#treatment-popup-patient-id').val(patient_id.val());

            document.getElementById('treatment-popup').style.visibility="visible";
        }

        function close_treatment_popup(){
            document.getElementById('treatment-popup').style.visibility="hidden";
        }

        //popup to edit
        function show_treatment_history(patient_id){
            console.log('#treatment-history-'+patient_id.val())
            document.getElementById('treatment-history-'+patient_id.val()).style.visibility = "visible";
        }

        function close_treatment_history(treatment_history_div){
            treatment_history_div.css("visibility","hidden");
        }

    </script>

{% endblock %}












<!-- 

            setInterval(function(){

                //for each div in 'chat-messages' class
                $('.chat-messages').each(function(){
                    
                    //getting chatroom id from this div's brother's val
                    chatroom_id = $(this).parent().children('input').val()
                    //console.log(chatroom_id)

                    $.ajax({
                        type : 'GET',
                        url : 'updateMessages/'+ chatroom_id,

                        //take response (contains info of messages in chatroom) and show messages
                        success : function(response){
                            //empty the div
                            $('.chat-messages').empty();

                            //console.log(response.user)

                            for (var key in response.messages){
                                temp = "<hr><p><b>"+response.messages[key].username+"</b></p> <p>"+response.messages[key].message_text+"</p> <p>"+response.messages[key].date+"</p>";
                                $('.chat-messages').append(temp);
                            }
                        }
                    });
                });

                }, 1000);


 -->